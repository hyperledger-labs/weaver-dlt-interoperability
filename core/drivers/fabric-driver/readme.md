# Fabric-Driver

This driver is for communication with a Fabric Network. 

This driver implements the Driver Service specified in the [driver.proto file](../../../common/interop-protos/driver/driver.proto).


## Development 

NOTE: Minimum requirement of npm v5.0 for patch-package to apply the patch for the fabric-network package.

### Setup

The .env (check .env.template, more information [here](#Environment-variables)) and config.json files need to be checked and updated to match the network and relay that it will be connecting to. 
The .env contains information related to the network and relay. The config.json contains information about the admin, user and ca that is used when connecting to the network. 

### Running

To do a full build run `npm install` and then `make`. This update/clones protos, generates js protos and compiles typescript. 

For tsc compilation in watch mode: `npm run watch` 

Running the server: `npm run dev`

Note: Can also be run in mocked mode by setting environment variable `MOCK=true`

## Deployment 

Make sure the env and config file have the expected values. 

Update the docker-compose with the correct external network and ports exposed

To do a full build run `npm install` and then `make build-image`. This update/clones protos, generates js protos and compiles typescript. 

To deploy, run `make deploy`

**Sample steps to use docker deployment:**

* After building image using `make build-image`, copy `.env.docker.template` to `.env` and make changes appropriately (like correcting the base path of repo, changing network name if required etc).
* Make sure connection profile used for docker, containers correct hostnames instead of localhost in urls.
* If deploying more than one driver on same host, make sure to change service name in docker-compose to avoid conflicts.
* Finally run `docker-compose up -d` to deploy the fabric driver.


### TL/MP Environment 

If you are spinning up the driver for the first time and plan to use docker in the TL/WT environemnt, either run the driver locally to generate the wallet, or copy across the wallet generated by the WT/TL application. This is to prevent issues with the CA denying creation of a new wallet. An alternative solution in the case that you have spun up the driver with docker without creating a wallet is to bash into the docker container and copy the contents of the created wallet and put them in the fabric-driver folder. 
The driver could be improved to have a way to revoke the prexisting identity in the CA and create a new one to avoid this issue. 


## Environment variables

The connection profile is required to set up the required material to communicate with the network. This should be supplied with the `CONNECTION_PROFILE` environeent variable (ex: CONNECTION_PROFILE=path/to/con_profile.json)

Port for connecting relay: `RELAY_ENDPOINT` (ex: RELAY_ENDPOINT=localhost:9081 )

Boolean for when to use mocked fabric communication: `MOCK` (ex: MOCK=true)

Port for the driver to be run on: `DRIVER_ENDPOINT` (ex: DRIVER_ENDPOINT=localhost:9093)

Can pass in a variable 'local' for working with fabric and docker: `local` (ex: local=false)

Can pass in a config file for the driver to be run with: `DRIVER_CONFIG` (ex: DRIVER_CONFIG=../custom_config.json)

NOTE: When specifying ensure that they match the config that the relay is using. 


## Known Issues

If running an old version of linux or experiancing this issue 

```
/lib64/libstdc++.so.6: version `CXXABI_1.3.8' not found 
```

Install libstdc++.so library that is  CXXABI_1.3.8 version
Update /lib64 folder with the new library or replace the existing link


## NOTE

Due to how fabric works and the CA works once a wallet has been created with identities in the CA you can not create new wallet without fist revoking the original credentials. This can have some issues if you have deleted a wallet and are trying to recreate one.
